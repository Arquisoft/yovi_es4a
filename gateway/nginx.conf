# El bloque 'events' configura el comportamiento general de las conexiones de red.
events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Mapa para manejar WebSockets de forma dinámica
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        listen 80;
        server_name _; 
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        server_name _; 

        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # A) WebApp
        location / {
            proxy_pass http://webapp:80; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_intercept_errors on;
            error_page 404 =200 /;
        }

        # B) Usuarios
        location /api/users/ {
            # Ponemos la barra final "/" para que Rust/Node reciba la ruta limpia (sin /api/users)
            proxy_pass http://users:3000/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # C) Juego (Gamey)
        location /api/game/ {
            # ¡IMPORTANTE!: La barra final "/" después de "4000" hace que Nginx 
            # elimine "/api/game" de la URL antes de enviarla a Rust.
            # Así Rust recibe "/v1/game/new" y el 404 desaparece.
            proxy_pass http://gamey:4000/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }
}